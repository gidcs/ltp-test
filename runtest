#!/bin/bash

export LTPROOT="/opt/ltp"
export PATH=${LTPROOT}/testcases/bin:$PATH
export TESTLIST="${PWD}/testlist"
export OUTPUT="${PWD}/output"
mkdir $OUTPUT  > /dev/null 2>&1
cd $OUTPUT

function help(){
    echo ""
    echo "Usage: "
    echo "    ./runtest io"
    echo "    ./runtest mem"
    echo "    ./runtest net"
    echo "    ./runtest all"
    echo "    ./runtest test"
    echo ""
}

function __runltp(){
    local _test=$1
    echo "************ Running ${_test} tests "
    sort -R ${TESTLIST}/${_test} -o ${OUTPUT}/ltp-${_test}
    ${LTPROOT}/bin/ltp-pan -e -S -a ${_test} -n ${_test} \
        -l ${OUTPUT}/${_test}.logfile \
        -o ${OUTPUT}/${_test}.outfile \
        -p -f ${OUTPUT}/ltp-${_test} &
    wait $!
    sync
    echo "************ End Running ${_test} tests "
}

function io(){
    echo "IO test begin"
    date

    export TMPBASE="/tmp"
    export TMP="${LTPROOT}/tmp"
    export TMPDIR="$TMP/aiodio"
    mkdir $TMP  > /dev/null 2>&1
    mkdir $TMP/junkdir  > /dev/null 2>&1
    file1="$TMP/file1"

    mkdir $TMPDIR  > /dev/null 2>&1

    if [ ! -f ${file1} ]; then
        dd if=/dev/urandom of=$file1 bs=1M count=100
    fi

    dd if=$file1 of=$TMPDIR/junkfile bs=8192 conv=block,sync
    __runltp "aio_stress"
    __runltp "aio_stress_extended"

    dd if=$file1 of=$TMPDIR/junkfile bs=8192 conv=block,sync
    dd if=$file1 of=$TMPDIR/fff      bs=4096 conv=block,sync
    dd if=$file1 of=$TMPDIR/ff1      bs=2048 conv=block,sync
    dd if=$file1 of=$TMPDIR/ff2      bs=1024 conv=block,sync
    dd if=$file1 of=$TMPDIR/ff3      bs=512  conv=block,sync
    __runltp "aio_cp"
    __runltp "aiodio_sparse"
    __runltp "fsx_linux"

    dd if=$file1 of=$TMPDIR/file2      bs=2048 conv=block,sync
    dd if=$file1 of=$TMPDIR/file3      bs=1024 conv=block,sync
    dd if=$file1 of=$TMPDIR/file4      bs=512  conv=block,sync
    dd if=$file1 of=$TMPDIR/file5      bs=4096 conv=block,sync
    __runltp "dio_sparse_and_others"

    __runltp "aio_dio"

    rm -f $TMPDIR/fff
    rm -f $TMPDIR/ff1
    rm -f $TMPDIR/ff2
    rm -f $TMPDIR/ff3
    rm -f $TMPDIR/junkfile*
    rm -f $TMPDIR/file*

    date
    echo "IO test end"
}

function mem(){
    echo "MEM test begin"
    date

    __runltp "mem"

    date
    echo "MEM test end"
}

function net(){
    echo "NET test begin"
    date

    . ../netconf.env
    __runltp "net"

    date
    echo "NET test end"
}

function test(){
    echo "test begin"
    date

    __runltp "test"

    date
    echo "test end"
}

case "$1" in
    "io") io;;
    "mem") mem;;
    "net") net;;
    "all") io; mem; net;;
    "test") test;;
    *) help; exit 1;;
esac
